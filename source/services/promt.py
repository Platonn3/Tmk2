from db.db_connection import DbConnection


def get_prompt(user_query: str) -> str:
    conn = DbConnection()
    documents = conn.search(user_query, neighbor_window=2)

    context_parts = []

    if documents:
        for doc in documents:
            content = doc.page_content.strip()

            context_parts.append(content)

        full_context = "\n\n".join(context_parts)

        final_prompt = f"""
Твоя роль: Опытный научный исследователь-аналитик.
Твоя задача: Сформулировать обоснованную научную гипотезу по запросу пользователя, основываясь на предоставленном КОНТЕКСТЕ.

ЗАПРОС ПОЛЬЗОВАТЕЛЯ: "{user_query}"

КОНТЕКСТ (найденные фрагменты из базы знаний):
{full_context}

ИНСТРУКЦИИ:
1. Проанализируй предоставленный контекст. Это фактологическая база.
2. Сформулируй четкую научную гипотезу, отвечающую на запрос.
3. ОБЯЗАТЕЛЬНО ссылайся на источники из контекста, подтверждающие твои тезисы.
4. Если информации в контексте недостаточно, дополни ответ общими научными знаниями, НО явно укажи, что это внешняя информация.
5. При использовании внешних знаний опирайся только на проверенные научные данные (уровень рецензируемых журналов, таких как Nature, Science, или профильных изданий по металлургии/физике).
6. Структура ответа: 
   - Гипотеза (кратко)
   - Обоснование (на основе контекста)
   - Ссылки на источники.
"""
    else:
        final_prompt = f"""
Твоя роль: Опытный научный исследователь.
ЗАПРОС ПОЛЬЗОВАТЕЛЯ: "{user_query}"

К сожалению, во внутренней базе знаний не найдено точных совпадений по этому вопросу.
Пожалуйста:
1. Сформулируй научную гипотезу, основываясь на своих общих знаниях.
2. Используй информацию только из общепризнанных научных фактов и теорий.
3. Укажи, что ответ дан без опоры на предоставленные документы.
"""

    return final_prompt


if __name__ == "__main__":
    query = "Theoretical Analyses of Hydrogen-rich Reduction in Blast Furnace"
    prompt_text = get_prompt(query)

    print(prompt_text)




